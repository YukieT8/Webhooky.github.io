<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Discord Webhook Manager — Glass Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <i class="fa-brands fa-discord"></i>
        <h1>Discord Webhook Manager</h1>
        <span class="badge">Glass Pro</span>
      </div>
      <div class="toolbar">
        <label class="switch" title="Light / Dark">
          <input id="theme-toggle" type="checkbox" />
          <span style="font-size:12px;color:var(--muted)">Тема</span>
        </label>
        <button id="save-btn" class="btn secondary"><i class="fa-regular fa-floppy-disk"></i> Сохранить</button>
        <button id="load-btn" class="btn ghost"><i class="fa-solid fa-rotate"></i> Загрузить</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Form -->
      <div class="card">
        <div class="card-header">
          <h2>Настройки & Контент</h2>
          <div class="helpbar">
            <span class="kbd">CTRL</span> + <span class="kbd">S</span> — сохранить • <span class="kbd">CTRL</span> + <span class="kbd">Enter</span> — отправить
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div>
              <label>Webhook URL</label>
              <input id="webhook-url" type="url" placeholder="https://discord.com/api/webhooks/..." />
            </div>
            <div>
              <label>Thread ID <span class="hint">(опционально)</span></label>
              <input id="thread-id" type="text" placeholder="123456789012345678" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Username</label>
              <input id="username" type="text" placeholder="Boty McBotface" />
            </div>
            <div>
              <label>Avatar URL</label>
              <input id="avatar-url" type="url" placeholder="https://.../avatar.png" />
            </div>
          </div>
          <div class="row-1">
            <div>
              <label>Сообщение (content)</label>
              <textarea id="message-content" placeholder="Текст сообщения..."></textarea>
              <label class="switch" style="margin-top:8px"><input id="tts" type="checkbox" /> TTS</label>
            </div>
          </div>

          <div class="sep"></div>
          <div class="row-3">
            <div>
              <label>Embed Title</label>
              <input id="embed-title" type="text" placeholder="Заголовок" />
            </div>
            <div>
              <label>Embed URL</label>
              <input id="embed-url" type="url" placeholder="https://..." />
            </div>
            <div>
              <label>Цвет</label>
              <input id="embed-color" type="color" value="#8b5cf6" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Описание</label>
              <textarea id="embed-description" placeholder="Описание (поддерживает переносы)"></textarea>
            </div>
            <div>
              <label>Временная метка</label>
              <select id="embed-timestamp" style="width:100%; padding:12px; border-radius:12px; background:rgba(2,6,23,.2); color:var(--text); border:1px solid var(--border)">
                <option value="false">Без timestamp</option>
                <option value="true">Добавить ISO-время</option>
              </select>
              <div style="height:8px"></div>
              <label>Автор — имя</label>
              <input id="author-name" type="text" placeholder="Discord Bot" />
              <label>Автор — URL</label>
              <input id="author-url" type="url" placeholder="https://..." />
              <label>Автор — icon URL</label>
              <input id="author-icon" type="url" placeholder="https://.../icon.png" />
            </div>
          </div>

          <div class="sep"></div>
          <div class="row">
            <div>
              <label>Embed Image URL</label>
              <input id="image-url" type="url" placeholder="https://.../image.png" />
            </div>
            <div>
              <label>Thumbnail URL</label>
              <input id="thumbnail-url" type="url" placeholder="https://.../thumb.png" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Вложение (картинка) — перетащи сюда или выбери файл</label>
              <div id="dropzone" class="dropzone">
                <i class="fa-regular fa-image"></i> Перетащи файл сюда или кликни
                <input id="file-input" type="file" accept="image/*" style="display:none" />
              </div>
              <div id="attachment-name" class="hint" style="margin-top:6px"></div>
            </div>
            <div>
              <label>Предпросмотр вложения</label>
              <img id="attachment-preview" class="preview-img" alt="preview" />
            </div>
          </div>

          <div class="sep"></div>
          <div class="row-1" id="fields-container">
            <div style="display:flex; align-items:center; justify-content:space-between">
              <label style="margin:0">Поля (fields)</label>
              <div class="toolbar">
                <button id="add-field" class="btn"><i class="fa-solid fa-plus"></i> Поле</button>
                <button id="clear-fields" class="btn ghost"><i class="fa-regular fa-trash-can"></i> Очистить</button>
              </div>
            </div>
            <div id="fields-list"></div>
          </div>

          <div class="sep"></div>
          <div class="toolbar">
            <button id="send-btn" class="btn ok"><i class="fa-solid fa-paper-plane"></i> Отправить</button>
            <button id="reset-btn" class="btn err"><i class="fa-solid fa-eraser"></i> Сбросить</button>
            <span id="status" class="hint"></span>
          </div>

        </div>
      </div>

      <!-- RIGHT: Preview -->
      <div class="card">
        <div class="card-header">
          <h2>Предпросмотр (похоже на Discord)</h2>
          <div class="toolbar">
            <span class="hint">живое обновление</span>
          </div>
        </div>
        <div class="card-body">
          <div class="discord">
            <div class="avatar" id="preview-avatar"></div>
            <div class="message">
              <div><span class="name" id="preview-username">Webhook Bot</span> <span class="hint" id="preview-time">сейчас</span></div>
              <div id="preview-content" style="white-space:pre-wrap; margin-top:6px"></div>
              <div class="embed" id="preview-embed" style="display:none">
                <div class="etitle" id="preview-embed-title"></div>
                <div class="edesc" id="preview-embed-desc"></div>
                <div class="fields" id="preview-fields"></div>
                <div id="preview-embed-image-wrap" style="margin-top:10px; display:none">
                  <img id="preview-embed-image" class="preview-img" style="max-height:220px" />
                </div>
                <div class="footer" id="preview-footer"></div>
              </div>
            </div>
          </div>
          <div class="sep"></div>
          <label>Сырой ответ сервера</label>
          <textarea id="response-area" placeholder="Ответ Discord появится здесь..." style="font-family: 'JetBrains Mono', monospace; min-height:120px"></textarea>
        </div>
      </div>
    </div>

    <div class="toasts" id="toasts"></div>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    function toast(msg, type='ok', ttl=2600){
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<i class="fa-solid ${type==='ok'?'fa-circle-check':'fa-triangle-exclamation'}"></i><span class="msg">${msg}</span>`;
      $('#toasts').appendChild(t);
      setTimeout(()=>{ t.style.transition='opacity .25s'; t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, ttl);
    }

    // ---------- theme ----------
    const themeToggle = $('#theme-toggle');
    function applyTheme(){
      document.documentElement.setAttribute('data-theme', localStorage.getItem('dw_theme')||'dark');
      themeToggle.checked = (localStorage.getItem('dw_theme')||'dark')==='light';
    }
    themeToggle.addEventListener('change', ()=>{
      localStorage.setItem('dw_theme', themeToggle.checked ? 'light' : 'dark');
      applyTheme();
    });
    applyTheme();

    // ---------- fields dynamic ----------
    function fieldTpl(){
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.innerHTML = `
        <div class="field-container" style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:end">
          <div>
            <label>Имя</label>
            <input class="field-name-input" type="text" placeholder="Поле" />
          </div>
          <div>
            <label>Значение</label>
            <input class="field-value-input" type="text" placeholder="Значение" />
          </div>
          <div style="display:flex; gap:8px; align-items:center; padding-bottom:4px">
            <label class="switch"><input class="field-inline" type="checkbox" /><span style="font-size:12px;color:var(--muted)">inline</span></label>
            <button class="btn ghost rm-field" title="Удалить"><i class="fa-regular fa-trash-can"></i></button>
          </div>
        </div>`;
      wrap.querySelector('.rm-field').addEventListener('click', ()=>{ wrap.remove(); livePreview(); });
      $$('#fields-list').push?.();
      return wrap;
    }
    $('#add-field').addEventListener('click', ()=>{ $('#fields-list').appendChild(fieldTpl()); livePreview(); });
    $('#clear-fields').addEventListener('click', ()=>{ $('#fields-list').innerHTML=''; livePreview(); });

    // ---------- drag & drop ----------
    const dropzone = $('#dropzone');
    const fileInput = $('#file-input');
    const attachName = $('#attachment-name');
    const attachPreview = $('#attachment-preview');

    function pickFile(){ fileInput.click(); }
    dropzone.addEventListener('click', pickFile);
    ;['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, e=>{ e.preventDefault(); dropzone.classList.remove('drag'); }));
    dropzone.addEventListener('drop', e=>{
      if(e.dataTransfer.files && e.dataTransfer.files[0]){
        fileInput.files = e.dataTransfer.files; afterPick();
      }
    });
    fileInput.addEventListener('change', afterPick);
    function afterPick(){
      const f = fileInput.files[0];
      if(!f){ attachName.textContent=''; attachPreview.src=''; livePreview(); return; }
      attachName.textContent = `Выбрано: ${f.name} (${Math.round(f.size/1024)} KB)`;
      const url = URL.createObjectURL(f);
      attachPreview.src = url;
      livePreview();
    }

    // ---------- live preview ----------
    const p = {
      avatar: $('#preview-avatar'),
      user: $('#preview-username'),
      time: $('#preview-time'),
      content: $('#preview-content'),
      embed: $('#preview-embed'),
      etitle: $('#preview-embed-title'),
      edesc: $('#preview-embed-desc'),
      fields: $('#preview-fields'),
      eimgWrap: $('#preview-embed-image-wrap'),
      eimg: $('#preview-embed-image'),
      footer: $('#preview-footer')
    };

    function livePreview(){
      const username = $('#username').value.trim() || 'Webhook Bot';
      const avatar = $('#avatar-url').value.trim();
      p.user.textContent = username;
      p.avatar.style.backgroundImage = avatar ? `url(${avatar})` : 'none';
      p.avatar.style.backgroundSize = 'cover';
      p.content.textContent = $('#message-content').value;

      // embed
      const title=$('#embed-title').value.trim();
      const url=$('#embed-url').value.trim();
      const desc=$('#embed-description').value;
      const color=$('#embed-color').value;
      const ts=$('#embed-timestamp').value==='true';
      const imageUrl=$('#image-url').value.trim();
      const thumbUrl=$('#thumbnail-url').value.trim();
      const file=fileInput.files[0];

      let has=false;
      if(title){ p.etitle.innerHTML = url?`<a class="link" href="${url}" target="_blank">${title}</a>`:title; has=true; } else { p.etitle.textContent=''; }
      if(desc){ p.edesc.textContent = desc; has=true; } else { p.edesc.textContent=''; }

      // fields render
      p.fields.innerHTML='';
      $$('#fields-list .field-container').forEach(c=>{
        const name=c.querySelector('.field-name-input').value.trim();
        const value=c.querySelector('.field-value-input').value.trim();
        const inline=c.querySelector('.field-inline').checked;
        if(!name||!value) return;
        const el=document.createElement('div');
        el.className='field'; el.style.gridColumn= inline? 'span 1' : '1 / -1';
        el.innerHTML=`<div class="fname">${name}</div><div>${value}</div>`;
        p.fields.appendChild(el); has=true;
      });

      // image priority: file attachment -> imageUrl
      let imgShown=false;
      if(file){
        p.eimg.src = URL.createObjectURL(file);
        p.eimgWrap.style.display='block'; imgShown=true; has=true;
      } else if(imageUrl){
        p.eimg.src=imageUrl; p.eimgWrap.style.display='block'; imgShown=true; has=true;
      } else { p.eimg.src=''; p.eimgWrap.style.display='none'; }

      // footer
      let ft='';
      if(ts){ ft += new Date().toLocaleString(); }
      if(thumbUrl){ ft += (ft?' • ':'') + 'thumb: '+thumbUrl; }
      p.footer.textContent = ft;

      p.embed.style.display = has? 'block':'none';
      p.embed.style.borderLeftColor = color;
    }

    // attach live listeners
    ['input','change','keyup'].forEach(ev=>{
      document.body.addEventListener(ev, e=>{
        if(e.target.matches('input, textarea, select')) livePreview();
      });
    });

    // ---------- save/load (localStorage) ----------
    const LS_KEY = 'dw_config_v2';
    function collect(){
      const cfg={
        webhookUrl: $('#webhook-url').value,
        threadId: $('#thread-id').value,
        username: $('#username').value,
        avatarUrl: $('#avatar-url').value,
        content: $('#message-content').value,
        tts: $('#tts').checked,
        embed:{
          title: $('#embed-title').value, url: $('#embed-url').value, description: $('#embed-description').value,
          color: $('#embed-color').value, timestamp: $('#embed-timestamp').value,
          author:{ name: $('#author-name').value, url: $('#author-url').value, icon: $('#author-icon').value },
          imageUrl: $('#image-url').value, thumb: $('#thumbnail-url').value,
          fields: $$('#fields-list .field-container').map(c=>({
            name:c.querySelector('.field-name-input').value,
            value:c.querySelector('.field-value-input').value,
            inline:c.querySelector('.field-inline').checked,
          }))
        }
      };
      return cfg;
    }
    function apply(cfg){
      if(!cfg) return;
      $('#webhook-url').value = cfg.webhookUrl||'';
      $('#thread-id').value = cfg.threadId||'';
      $('#username').value = cfg.username||'';
      $('#avatar-url').value = cfg.avatarUrl||'';
      $('#message-content').value = cfg.content||'';
      $('#tts').checked = !!cfg.tts;
      if(cfg.embed){
        $('#embed-title').value = cfg.embed.title||'';
        $('#embed-url').value = cfg.embed.url||'';
        $('#embed-description').value = cfg.embed.description||'';
        $('#embed-color').value = cfg.embed.color||'#8b5cf6';
        $('#embed-timestamp').value = cfg.embed.timestamp||'false';
        $('#author-name').value = (cfg.embed.author&&cfg.embed.author.name)||'';
        $('#author-url').value = (cfg.embed.author&&cfg.embed.author.url)||'';
        $('#author-icon').value = (cfg.embed.author&&cfg.embed.author.icon)||'';
        $('#image-url').value = cfg.embed.imageUrl||'';
        $('#thumbnail-url').value = cfg.embed.thumb||'';
        $('#fields-list').innerHTML='';
        (cfg.embed.fields||[]).forEach(f=>{ const el=fieldTpl();
          el.querySelector('.field-name-input').value=f.name||'';
          el.querySelector('.field-value-input').value=f.value||'';
          el.querySelector('.field-inline').checked=!!f.inline;
          $('#fields-list').appendChild(el);
        });
      }
      livePreview();
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(collect())); toast('Сохранено', 'ok'); }
    function load(){ const cfg = JSON.parse(localStorage.getItem(LS_KEY)||'null'); apply(cfg); toast('Загружено', 'ok'); }
    $('#save-btn').addEventListener('click', save);
    $('#load-btn').addEventListener('click', load);
    window.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); save(); }
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); sendWebhook(); }
    });
    // авто-загрузка при старте
    apply(JSON.parse(localStorage.getItem(LS_KEY)||'null'));

    // ---------- send webhook (multipart для файла) ----------
    async function sendWebhook(){
      const webhookUrl = $('#webhook-url').value.trim();
      const responseArea = $('#response-area');
      responseArea.value='';
      if(!/^https:\/\/discord\.com\/api\/webhooks\//.test(webhookUrl)){
        toast('Укажи корректный Webhook URL', 'err');
        return;
      }

      const payload = {
        username: $('#username').value.trim() || undefined,
        avatar_url: $('#avatar-url').value.trim() || undefined,
        content: $('#message-content').value.trim() || undefined,
        tts: $('#tts').checked,
        embeds: []
      };
      const threadId = $('#thread-id').value.trim();
      if(threadId) payload.thread_id = threadId; // при запросе добавится как query-параметр у Discord

      const embed = {};
      let hasEmbed = false;

      const t=$('#embed-title').value.trim(); if(t){ embed.title=t; hasEmbed=true; }
      const u=$('#embed-url').value.trim(); if(u){ embed.url=u; hasEmbed=true; }
      const d=$('#embed-description').value; if(d){ embed.description=d; hasEmbed=true; }
      const ts = $('#embed-timestamp').value==='true'; if(ts){ embed.timestamp = new Date().toISOString(); hasEmbed=true; }
      const color = $('#embed-color').value; if(color){ const c=parseInt(color.replace('#',''),16); if(!isNaN(c)){ embed.color=c; hasEmbed=true; }}

      const an=$('#author-name').value.trim();
      const au=$('#author-url').value.trim();
      const ai=$('#author-icon').value.trim();
      if(an){ embed.author={ name: an }; if(au) embed.author.url=au; if(ai) embed.author.icon_url=ai; hasEmbed=true; }

      const fl=[]; $$('#fields-list .field-container').forEach(c=>{
        const n=c.querySelector('.field-name-input').value.trim();
        const v=c.querySelector('.field-value-input').value.trim();
        const i=c.querySelector('.field-inline').checked;
        if(n && v) fl.push({name:n, value:v, inline:i});
      });
      if(fl.length){ embed.fields=fl; hasEmbed=true; }

      const file = fileInput.files[0];
      const imageUrl = $('#image-url').value.trim();
      const thumb = $('#thumbnail-url').value.trim();

      let useForm=false; let formData=null;
      if(file){
        embed.image = { url: 'attachment://' + file.name };
        hasEmbed = true; useForm=true;
      } else {
        if(imageUrl){ embed.image = { url: imageUrl }; hasEmbed = true; }
      }
      if(thumb){ embed.thumbnail = { url: thumb }; hasEmbed=true; }

      if(hasEmbed) payload.embeds.push(embed);
      if(!(payload.content && payload.content.length) && !hasEmbed){ toast('Сообщение пустое — добавь текст или embed', 'err'); return; }

      const btn = $('#send-btn');
      btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Отправка...';

      try{
        let res;
        if(useForm){
          formData = new FormData();
          formData.append('payload_json', JSON.stringify(payload));
          formData.append('files[0]', file, file.name);
          res = await fetch(webhookUrl, { method:'POST', body: formData });
        } else {
          res = await fetch(webhookUrl, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
          });
        }
        const text = await res.text();
        if(res.ok){ toast('Отправлено ✔', 'ok'); responseArea.value = text || 'OK'; }
        else{ toast('Ошибка отправки', 'err'); responseArea.value = `HTTP ${res.status} — ${text}`; }
      } catch(e){
        toast('Ошибка: '+e.message, 'err');
        responseArea.value = 'Exception: ' + e.message;
      } finally{
        btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Отправить';
      }
    }

    $('#send-btn').addEventListener('click', sendWebhook);
    $('#reset-btn').addEventListener('click', ()=>{ localStorage.removeItem(LS_KEY); location.reload(); });

    // стартовый render
    livePreview();
  </script>
</body>
</html>
